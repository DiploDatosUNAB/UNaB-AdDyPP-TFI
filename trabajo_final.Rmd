---
title: "Asistencias a los Puntos Digitales"
subtitle: "Trabajo Final Integrador"
author: Valeria Aguirre, Alejandro Blasco, Fernanda López Franz, Pilar Thill
date: "2023-10-20"
output:
  html_document:
    theme: flatly
    # highlight: zenburn
    highlight: pygments
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
      number_sections: true
    code_folding: hide
---

<head>
  <link href="https://fonts.googleapis.com/css?family=Libre+Franklin:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Google+Font+Name&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"> 
  <link href="https://fonts.googleapis.com/css2?family=Encode+Sans:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet" >
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700&display=swap" rel="stylesheet">
</head>

<style>
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    background-color: #016763;
}
body {
  font-family: 'Libre Franklin', system-ui, 'Segoe UI', Roboto, Helvetica, 'Arial', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', 'Source Sans Pro', 'Lato', 'Helvetica Neue', sans-serif;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***UNaB***\
*Diplomatura en Análisis de Datos para el Desarrollo de Políticas Públicas*\
Universidad Nacional Guillermo Brown

***Coordinador:***\
Juan Domingo González


# Objetivos Generales
Referidos al propósito de la investigación, los Objetivos Generales son potenciales,  puede ser algo muy genérico como “Comprender la problemática del sector X ”

# Objetivos Específicos   
El objetivo específico refleja el resultado esperable en el plazo previsto para la realización del plan. 
El objetivo general, al cual contribuye el objetivo específico, se orienta hacia resultados posibles de obtener en el largo plazo en la línea de investigación mediante trabajos futuros no incluidos en el plan.

# Antecedentes 
Indicar el estado de la situación, y en lo posible, trabajos similares en literatura especializada o casos de estudio similares que comparten elementos con el tema planteado.

# Actividades y metodología
Indicar si la factibilidad del trabajo propuesto, datos disponibles para hacer los análisis, acceso a software especial de análisis de datos y bibliografía. En este análisis, prestar especial atención al tiempo disponible para realizar el trabajo, teniendo en cuenta que es un plan acotado con fecha final aproximada 31-08-2023.
*   Repositorio de datos GitHub: https://github.com/DiploDatosUNAB/UNaB-AdDyPP-TFI 
*   Drive: 09-Proyecto Final 
*   Instructivo: Plan de Trabajo - Instructivo.docx
*   Colab: UNaB - AdDyPP - Trabajo Final Integrador.ipynb

# Referencias
Incluir libros, artículos científicos, sitios web, repositorios digitales de datos asociados al plan.  En lo posible, hacerlo siguiendo las normas bibliográficas académicas. Por ejemplo https://biblioguias.uma.es/citasybibliografia/ejemplosAPA

## 0. Acciones Preliminares

**Variables de Entorno**
```{r variables}
# Warnings de Librerías
WARN_ACT <- FALSE
PATH <- "datos/"
PATH2 <- "datos/actividades/"
puntos_arch <- "puntos_digitales.csv"
comp_arch <- "departamentos.7z"
depto_arch <- "departamentos.json"
indic_arch <- "indicadores.shp"
```

**Instalación condicional de librerías**

Instala solos si detecta que falta instalarlas.
```{r instalar}
# instalación condicional de librerías (solo instala si faltan)
# https://stackoverflow.com/questions/66869137/installing-r-packages-in-colab
# https://stackoverflow.com/questions/63594521/install-a-r-package-permanently-in-google-colab
instalar <- function(libreria) {
  if (!requireNamespace(libreria, quietly = TRUE)) {
    install.packages(libreria)
  }
}
instalar("gt")
instalar("gtExtras")
instalar("tmap")
instalar("sf")
instalar("leaflet")
instalar("archive")
instalar("ggplot2")

# instalar("Hmisc")
# instalar("purrr")
# instalar("lattice")
# instalar("readr")
# instalar("cluster")
# instalar("dplyr")
# instalar("stats")
# instalar("stringr")
# instalar("corrplot")
# instalar("ergm") para medianas ponderadas. No utilizado
# demora 30-45 segundos
# instalar("psych")
# demora demora 3-8 segundos
# instalar("skimr")
# demora 5-7 minutos
# instalar("caret")
```

**Carga de librerías**
```{r librerias}
# Función de carga condicional de librerías (solo carga si están instaladas)
cargar <- function(libreria, warns = WARN_ACT) {
  if (requireNamespace(libreria, quietly = TRUE)) {
    if(warns) {
      library(libreria, character.only = TRUE)
    } else{
      suppressMessages(library(libreria, character.only = TRUE))
    }
    
  }
}

# carga de librerías a utilizar
cargar("readr")        # lectura de datos
cargar("dplyr")        # manipulación de df
cargar("gt")           # tablas
cargar("gtExtras")     # tablas
cargar("tmap")         # mapas interactivos
cargar("sf")           # datos geoespaciales
cargar("leaflet")      # mapas interactivos
cargar("archive")      # urilidades
cargar("ggplot2")      # graficación

# cargar("lattice")      # graficación estadistica
# cargar("cluster")      # clustering
# cargar("skimr")        # estadísticas
# cargar("stats")        # estadísticas
# cargar("kableExtra") # tablas
# cargar("psych")        # estadísticas
# cargar("purrr")        # manejo de listas
# cargar("IRdisplay")  # display de notebook
# cargar("tidyverse")    # conjunto de paquetes tidy
# cargar("stringr")      # cadenas de caracteres
# cargar("corrplot")     # grafico de correlación
# cargar("Hmisc")        # correlaciones
# cargar("caret")        # entrenamiento
# cargar("ergm")        # análisis estadísticos
```


## 1. Tablas

### 1.1 Puntos Digitales

#### 1.1.1 Listado de Puntos Digitales

El Programa Punto Digital cuenta con dispositivos instalados a lo largo y ancho del territorio argentino. Su objetivo fundamental es la reducción de la brecha digital a los fines de contribuir a la mejora de la calidad de vida de las y los habitantes del país. Esta tabla contiene el listado de los puntos digitales.

```{r carga_puntos}
# Puntos digitales

puntos <- read.csv(paste0(PATH, puntos_arch), sep = ",", encoding = "ISO-8859-1")

sample_n(puntos, 5) |> 
  dplyr::mutate(horarios = substr(horarios, 1, 20)) |>  # Truncar "horarios"
  gt() |> 
  tab_header(
    title = "Puntos Digitales*",
    subtitle = "* muestra"
  ) |>
  tab_options(table.width = "100%") |>
  opt_stylize(style = 5, color = 'cyan')

columnas <- c("id_pd", "nombre_pd", "direccion", "nombre_institucional",
              "id_provincia", "id_departamento", "id_localidad",
              "cod_bahra_localidad", "id_municipio", "provincia",
              "departamento", "localidad", "municipio", "mail_institucional",
              "latitud", "longitud", "horarios", "link_facebook", "estado")

```

**Dimensiones**
```{r dimensiones}
# dimensiones
cat("El DataFrame tiene", dim(puntos)[1], "observaciones y", dim(puntos)[2], "variables.")

```

**Medidas de tendencia central - Empleo AMBA**
```{r bloque014b}
# Descripción de Empleo AMBA sin desagregar
summary(puntos)
```


**Mapa**
```{r mapa_puntos}
# Geolocalización de Puntos Digitales
# https://rdrr.io/cran/tmap/man/tm_symbols.html
# https://r-tmap.github.io/tmap-book/layers.html

mostrar <- c("id_pd", "nombre_pd", "direccion", "provincia", "departamento",
             "localidad", "municipio", "estado")

# Capas
capas <- c(GrayMap = "Esri.WorldGrayCanvas", StreetMap = "OpenStreetMap", TopoMap = "Esri.WorldTopoMap")

# Geodataframe
puntos_sf <- puntos |> 
  select(2, 1, everything()) |>
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326)
# Gráfico
tmap_mode("view")
tm_basemap(capas) +
  tm_shape(puntos_sf, is.master = TRUE) +
  # tm_markers(size = 0.5, popup.vars = mostrar) +
  tm_dots(size = 0.1,  clustering = T, popup.vars = mostrar) + 
  tm_layout(main.title = "Puntos Digitales", main.title.size = 0.7);

```


**Diccionario**
```{r diccionario}
# diccionario de datos

descripciones <- c(
  "Identificador del Punto Digital",
  "Nombre del Punto Digital",
  "Dirección",
  "Nombre Institucional",
  "Identificador de la provincia",
  "Identificador del departamento",
  "Identificador de la localidad",
  "Codigo BAHRA (Asentamientos Urbanos)",
  "Identificador del municipio",
  "Provincia",
  "Departamento",
  "Localidad",
  "Municipio",
  "Mail Institucional",
  "Latitud",
  "Longitud",
  "Horarios",
  "Link Facebook",
  "Estado"
)

diccionario <- data.frame(
  Clase = sapply(puntos, class),
  Descripción = descripciones
)

diccionario <- tibble::rownames_to_column(diccionario, "Variable")

diccionario |>   
  gt(rowname_col = "Variable") |> 
  tab_header(
    title = "Diccionario de Datos",
  ) |>
  tab_options(table.width = "90%") |>
  gt_theme_dot_matrix()
```


#### 1.1.2 Indicadores

Se cargan indicadores sobre hogares con celualar y hogares con computadora del Censo 2010.

**Carga de Indicadores**
```{r indicadores}
indicadores_geo <- sf::st_read(paste0(PATH, indic_arch))
indicadores <- as.data.frame(indicadores_geo)
sample_n(select(indicadores,-geometry),10) |>
  gt(rowname_col = "DPTO_1") |> 
  tab_header(
    title = "Lista de Indicadores",
  ) |>
  tab_options(table.width = "100%") |>
  gt_theme_dot_matrix()

```
**Computadoras**
```{r compu_mapa}

ggplot(indicadores_geo, aes(fill = 100*H_COMPUTAD/H_TOTAL, geometry = geometry)) +
    geom_sf() +
    scale_fill_viridis_c(option = "B", 
                       limits = c(0, 100),
                       direction = -1,
                       name = "Hogares con Computadora",
                       labels = scales::percent_format(scale = 1)
                       ) +
    labs(title = "Hogares con Computadoras")

```


**Celulares**
```{r celu_mapa}

ggplot(indicadores_geo, aes(fill = 100*H_CELULAR/H_TOTAL, geometry = geometry)) +
    geom_sf() +
    scale_fill_viridis_c(option = "B", 
                       limits = c(0, 100),
                       direction = -1,
                       name = "Hogares con Celular",
                       labels = scales::percent_format(scale = 1)
                       ) +
    labs(title = "Hogares con Teléfono Celular")

```

**Polígonos de Departamentos IGN**
```{r departamentos}
# Descomprimir el archivo 7-Zip
if (!file.exists(file.path(PATH, depto_arch))) {
  archive_extract(paste0(PATH, comp_arch), PATH)
}

deptos_geo <- st_read(paste0(PATH, depto_arch))
deptos <- as.data.frame(deptos_geo)


sample_n(select(deptos, -geometry), 10) |>
  gt() |>
  tab_header(title = "Departamentos* - GeoDataFrame",
             subtitle = "* muestra"
             ) |>
  tab_options(table.width = "90%") |>
  gt_theme_pff()
```
```{r deptos_mapa}
ggplot() +
    geom_sf(data = subset(deptos_geo, in1!="94028")) + # 92028 antartida
    labs(title = "Partidos de Argentina")
# deptos_centroides <- deptos_geo |> 
# mutate (geometry = st_centroid(geometry))

```

#### 1.1.3 Actividades

Lista de Actividades de los Puntos Digitales

**Carga de Bases Mensuales**
```{r carga_act}
lista <- list()
archivos <- list.files(path = PATH2, pattern = "^[0-9]{4}-[0-9]{2}\\.csv")

for (archivo in archivos) {
  df <- read.csv(file.path(PATH2, archivo), sep = ",", encoding = "ISO-8859-1")
  # extrae fecha del n de archivo
  fecha <- strsplit(tools::file_path_sans_ext(archivo), "-", fixed = TRUE)[[1]]
  df <- df |> 
    mutate(anio = as.integer(trimws(fecha[1])),
           mes = as.integer(trimws(fecha[2])))
  lista <- c(lista, list(df))
}

actividades <- bind_rows(lista)

```


**Muestra de Actividades Mensuales**
```{r muestra_}
sample_n(actividades, 10) |> 
  gt() |> 
  tab_header(
    title = "Actividades*",
    subtitle = "* muestra"
  ) |>
  tab_options(table.width = "100%") |>
  opt_stylize(style = 5, color = 'cyan')
```


**Lista de actividades**
```{r listado}
# Cuadro de actividades 
# https://gt.albert-rapp.de/getting_started#use-groups-instead-of-repetitive-columns
# https://github.com/rstudio/gt/issues/577
# https://github.com/rstudio/gt/issues/545

act_listado <- actividades |> 
  select(eje, categoria, subcategoria)  |> 
  distinct() |> 
  arrange(eje, categoria, subcategoria)

act_listado |>
  gt(groupname_col = "eje") |>
  # cols_merge(columns = c(eje, categoria)) |> 
  tab_header(
    title = "Lista de Actividades*",
    subtitle = "* listado completo"
  ) |>
  tab_options(row_group.as_column = TRUE, table.width = "85%") |>
  opt_stylize(style = 5, color = 'cyan')
  
```




## 2. Otras

**Matriz de Correlación**
```{r natriz, eval=FALSE, include=FALSE}
# Matriz de correlación# 
# https://blog.hasanbul.li/2018/01/14/exporting-correlation-plots/
matriz_cor <- cor(puntos[, 6:16], use = "complete.obs")
knitr::kable(matriz_cor, format = "html")
# matriz_cor
```


**Gráfico de Correlación personalizado**
```{r correlaciones, eval=FALSE, include=FALSE}
# Gráfico de correlación
# https://www.khstats.com/blog/corr-plots/
# https://bookdown.org/ndphillips/YaRrr/saving-plots-to-a-file-with-pdf-jpeg-and-png.html
# https://copyprogramming.com/howto/how-to-save-a-plot-created-by-corrplot-function-in-r

# png(height=800, width=800, file="grafico_correlacion.png")
corrplot(
  matriz_cor,
  method = "color",          # Colores para representar la correlación
  type = "lower",            # Tipo de gráfico (triangular inferior)
  tl.col = "black",          # Color variables
  tl.srt = 45,               # Ángulo de rotación de las etiquetas
  addCoef.col = "black",     # Color coeficientes
  mar=c(1,1,1,1),            # Márgenes
  tl.cex = 0.6,              # Tamaño de letra variables
  number.cex = 0.55,         # Tamaño de letra coeficientes
  cl.cex = 0.6               # Tamaño de letra leyenda
  # diag = FALSE             # Diagonal
  )
# dev.off()
# matriz_cor
```





### Links
http://www.bahra.gob.ar/
https://r-tmap.github.io/tmap-book/layers.html
https://www.argentina.gob.ar/jefatura/innovacion-publica/servicios-y-pais-digital/punto-digital













